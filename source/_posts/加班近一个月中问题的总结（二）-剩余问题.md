---
title: 加班近一个月中问题的总结（二）-剩余问题
date: 2018-06-21 11:02:46
tags:
- bug
- js
---

上篇缓存问题，经后来多次测试发现，，，就只能等，一般一个小时后微信自己会清掉，微信这么个机制简直不给我们开发留活路，尝试过的办法在上一篇文章里，有懂的大神还望指教一二

好了继续说剩下的
<!--more-->
+ IOS定位问题，IOS10以上不让非https的方式获取，低版本下navigator获取地理位置有问题，直接错误码1，定位服务不可用，换用百度地图api后可行，不知道百度做了什么优化，翻源码好像也没有什么特别的
![](https://upload-images.jianshu.io/upload_images/11264410-ef20dbae7ec3e411.jpg)
+ 微信定位后会记住位置授权，需在系统设置里 `通用-设置-还原-还原位置与隐私` 中还原
+ IOS微信浏览器下方会有前进后退按钮，禁用方法
```javascript
history.pushState(null, null, document.URL)
window.addEventListener('popstate', function(){
  history.pushState(null, null, document.URL)
})
```
	最好写成一个函数，方便在恢复的时候removeEventListener
+ webview下获取地理位置失败，直接错误代码1，在安卓客户端websettings启用定位权限
+ 百度地图缩放移动特别卡。原因不详，问题所在：任意父级不能有fixed定位
+ 百度地图隐藏之后再显示只显示左上角一小块，原因：new BMap()只能执行一次
+ 百度地图坐标转换：批量转换一次不得超过十个
算法：
```javascript
var pages = []
for (var i = 0; i < len; i++) {
  var page = Math.floor(i / 10)
  if (pages[page]) {
    pages[page].push(pointArr[i])
  } else {
    pages[page] = [pointArr[i]]
  }
}
//分成每组10份的数组
var pageLen = pages.length
for(let i=0; i<pageLen; i++){
  convertor.translate(pages[i], 3, 5, function (data) {
	for (var j = 0; j < pages[i].length; j++) {
	  $scope.branchMarkers[i * 10 + j].BranchLongitude = data.points[j].lng
	  $scope.branchMarkers[i * 10 + j].BranchDimension = data.points[j].lat
	}
	// 转换完成
	if(i === pageLen-1){
	  addOverlay() // 获取到数据再插标
	}

  })
}
// 遍历插标
function addOverlay(){
  let branchLen = $scope.branchMarkers.length
  for (var i = 0; i < branchLen; i++) {
	var marker = new BMap.Marker(new BMap.Point($scope.branchMarkers[i].BranchLongitude, $scope.branchMarkers[i].BranchDimension));  // 创建标注
	$scope.map.addOverlay(marker);               // 将标注添加到地图中
	addClickHandler(marker, content);
  }
}
```
+ 清除标注map.clearOverlays()
+ 微信浏览器图片预览，仿着closeWindow写，竟然还真成功了，这个不需要config
```javascript
WeixinJSBridge.invoke('imagePreview', {
  current: curImageSrc, // 全路径
  urls   : imgArray     // 每一项都是全路径
}, fn)
```
+ select居中问题
想到的办法
	+ label，无效
	+ onclick，无效
	+ trigger，无效
	+ 定位，透明度设为0，将选中的值回显到span上即可。nice，jq就是这么做的
+ 低版本微信es6语法报错，同样safari无痕模式下也报错，配置gulp-babel解决此问题，还顺带语法检查的，嘻嘻
+ ios11数字键盘不起作用 用正则pattern="[0-9]*"，引发的坑，验证码前几位0的话会去掉 es2017新语法.padStart(6, '0')
+ 图片格式后缀大小写，本地正常，服务器上404
+ input上传压缩图片base64 ios设备下旋转90度 exif插件解决
```javascript
// 旋转图片
  function rotateImage(image) {
    var width = image.width;
    var height = image.height;
    
    var canvas = document.createElement("canvas")
    var ctx = canvas.getContext('2d');
    
    var newImage = new Image();
    
    //旋转图片操作
    EXIF.getData(image, function () {
        var orientation = EXIF.getTag(this, 'Orientation');
        // orientation = 6;//测试数据
        console.log('orientation:' + orientation);
        switch (orientation) {
          //旋转90度
          case 6:
            console.log('旋转90°');
            canvas.height = width;
            canvas.width = height;
            ctx.rotate(Math.PI / 2);
            ctx.translate(0, -height);
            
            ctx.drawImage(image, 0, 0);
              newImage.src = canvas.toDataURL('Image/jpeg', 1)
            break;
          //旋转180°
          case 3:
            console.log('旋转180°');
            canvas.height = height;
            canvas.width = width;
            ctx.rotate(Math.PI);
            ctx.translate(-width, -height);
            
            ctx.drawImage(image, 0, 0)
              newImage.src = canvas.toDataURL('Image/jpeg', 1)
            break;
          //旋转270°
          case 8:
            console.log('旋转270°');
            canvas.height = width;
            canvas.width = height;
            ctx.rotate(-Math.PI / 2);
            ctx.translate(-height, 0);
            
            ctx.drawImage(image, 0, 0)
              newImage.src = canvas.toDataURL('Image/jpeg', 1)
            break;
          default:
            newImage = image;
        }
      }
    );
    return newImage;
  }
}
```
完！