---
title: 页面插码之事件委托
date: 2018-09-04 16:43:42
tags: js
---
页面上有好多icon，要统计一天哪个icon被点击了多少次
+ 可以getElementxxxxxx，然后遍历addEventListener(click, fn)，但是每个元素都被挂了一个fn，很占资源
+ 事件代理，下面所有的icon都归父亲管，父亲去判断你点了哪个儿子，然后执行fn，fn自然也得挂在父亲上，来看代码吧，先来实现一个简单的
```javascript
  HTMLElement.prototype.delegate = function (selector, fn) {
    this.addEventListener('click', function (e) {
      var target = e.target
      if(target.tagName.toLowerCase() === selector){
        fn && fn()
      }
    })
  }
```
一个简单的委托就写好了。
### 但是，需要注意的是
**e.target只能取到最里面的元素**，而如果我们需要触发的元素是`div > span > a >img`中的`span`怎么办，这样e.target取到的就是img了，所以我们需要层层往上遍历找寻目标元素，所以，改进方法：
<!--more-->
```javascript
  HTMLElement.prototype.delegate = function (selector, fn) {
    this.addEventListener('click', function (e) {
      var target = e.target
      while(target.tagName.toLowerCase() !== selector && target !== this){
        target = target.parentNode
      }
      if(target === this){
        return false
      }
      fn && fn.call()
    })
  }
```
### 细节改进1：
**如果传的不是标签名呢？**
```javascript
  HTMLElement.prototype.delegate = function (selector, fn) {
    // 判断传进来的是tagName，id还是className
    var type = 'tagName';
    if(!selector || typeof selector !== 'string'){ return false }
    selector = selector
      .replace(/(^\s+)|(\s+$)/g, '')
      .replace(/(^#|^\.)/g, function(match, key){
        (key === '#') && (type = 'id');
        (key === '.') && (type = 'className')
        return ''
      })

    this.addEventListener('click', function (e) {
      var target = e.target
      while(target[type].toLowerCase() !== selector && target !== this){
        target = target.parentNode
      }
      if(target === this){
        return false
      }
      fn && fn()
    })
  }
```
### 细节改进2：
**回调函数中想使用当前元素。我们就给call进去`fn.call(target)`**
### 完整代码
```javascript
  HTMLElement.prototype.delegate = function (selector, fn) {
    var type = 'tagName';
    if(!selector || typeof selector !== 'string'){ return false }
    selector = selector
      .replace(/(^\s+)|(\s+$)/g, '')
      .replace(/(^#|^\.)/g, function(match, key){
        (key === '#') && (type = 'id');
        (key === '.') && (type = 'className')
        return ''
      })
    this.addEventListener('click', function (e) {
      var target = e.target
      while(target[type].toLowerCase() !== selector && target !== this){
        target = target.parentNode
      }
      if(target === this){
        return false
      }
      fn && fn.call(target) //将当前元素作为this
    })
  }
```
### 使用：
```javascript
  document.getElementById('main').delegate('a', function(){
    console.log(this) // <a>...</a>
  })
```
#### 每次只是想写个issue，却越写越长，只好发成博客